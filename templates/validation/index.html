{% extends "base.html" %}

{% block title %}Data Validation - {{ client_code }}{% endblock %}

{% block content %}
<div class="flex-between mb-2">
    <h1>Data Validation</h1>
    <div class="flex gap-1">
        <a href="{{ root_path }}/clients/{{ client_code }}/deletion" class="btn btn-danger">Batch Delete</a>
        <a href="{{ root_path }}/clients/{{ client_code }}" class="btn btn-secondary">Back to Project</a>
    </div>
</div>

<!-- FOLIO Statistics -->
<div class="card mb-2">
    <div class="card-header">
        <span class="card-title">FOLIO Platform Statistics</span>
        <button class="btn btn-sm btn-secondary" onclick="loadFolioStats()">Refresh</button>
    </div>
    <div id="folio-stats" class="p-2">
        <p class="text-muted">Loading FOLIO statistics...</p>
    </div>
</div>

<!-- Count Validation (Quick) -->
<div class="card mb-2">
    <div class="card-header">
        <span class="card-title">Count Validation (Quick)</span>
        <span class="badge badge-info">2 API calls</span>
    </div>
    <div class="p-2">
        <div class="alert alert-info mb-2">
            <strong>How it works:</strong>
            Compare FOLIO record count before and after BatchPoster execution.
            Pre-count is automatically captured when BatchPoster starts.
            Only needs 1 API call to get the current count.
        </div>

        <div class="form-group">
            <label for="count-execution-select">Select BatchPoster Execution</label>
            <select id="count-execution-select" class="form-control">
                <option value="">Loading BatchPoster executions...</option>
            </select>
        </div>

        <div id="count-exec-info" style="display: none;" class="mb-2">
            <small class="text-muted">
                Pre-execution count: <strong id="pre-count-display">-</strong> |
                Posted records: <strong id="posted-count-display">-</strong>
            </small>
        </div>

        <button id="count-btn" class="btn btn-primary" onclick="startCountValidation()" disabled>
            Run Count Validation
        </button>
    </div>
</div>

<!-- Count Validation Result Modal -->
<div id="count-result-modal" class="card mb-2" style="display: none;">
    <div class="card-header">
        <span class="card-title">Count Validation Result</span>
        <button class="btn btn-sm btn-secondary" onclick="document.getElementById('count-result-modal').style.display='none'">Close</button>
    </div>
    <div class="p-2">
        <div id="count-result-content"></div>
    </div>
</div>

<!-- Record-Level Validation -->
<div class="card mb-2">
    <div class="card-header">
        <span class="card-title">Record-Level Validation (Detailed)</span>
    </div>
    <div class="p-2">
        <div class="alert alert-info mb-2">
            <strong>Validation Workflow:</strong>
            <ol style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                <li>Select a <strong>Transformer</strong> execution (e.g., BibsTransformer)</li>
                <li>Make sure the corresponding <strong>BatchPoster</strong> has been executed</li>
                <li>Validation will compare the transformer output with FOLIO platform data</li>
            </ol>
        </div>

        <div class="form-group">
            <label for="execution-select">Select Completed Execution (Transformer only)</label>
            <select id="execution-select" class="form-control">
                <option value="">Loading executions...</option>
            </select>
        </div>

        <div class="form-group">
            <label for="sample-size">Sample Size (optional)</label>
            <input type="number" id="sample-size" class="form-control" placeholder="Leave empty to validate all records" min="1" max="1000">
            <small class="text-muted">Validate only a random sample of records (recommended for large datasets)</small>
        </div>

        <button id="start-btn" class="btn btn-primary" onclick="startValidation()" disabled>
            Start Validation
        </button>
    </div>
</div>

<!-- Validation History -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Validation History</span>
        <button class="btn btn-sm btn-secondary" onclick="loadValidations()">Refresh</button>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Validation ID</th>
                    <th>Type</th>
                    <th>Execution</th>
                    <th>Record Type</th>
                    <th>Status</th>
                    <th>Results</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="validations-table">
                <tr>
                    <td colspan="8" class="text-center text-muted">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Running Validation Progress -->
<div id="validation-progress" class="card mt-2" style="display: none;">
    <div class="card-header">
        <span class="card-title">Validation in Progress</span>
    </div>
    <div class="p-2">
        <div class="progress-bar mb-1">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
        <p id="progress-status" class="text-muted">Starting...</p>
        <div id="progress-stats" class="grid grid-4 mt-2" style="display: none;">
            <div class="stat-box">
                <span class="stat-value text-success" id="stat-found">0</span>
                <span class="stat-label">Found</span>
            </div>
            <div class="stat-box">
                <span class="stat-value text-danger" id="stat-not-found">0</span>
                <span class="stat-label">Not Found</span>
            </div>
            <div class="stat-box">
                <span class="stat-value text-warning" id="stat-mismatch">0</span>
                <span class="stat-label">Mismatch</span>
            </div>
            <div class="stat-box">
                <span class="stat-value text-muted" id="stat-errors">0</span>
                <span class="stat-label">Errors</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const clientCode = '{{ client_code }}';
let currentValidationId = null;
let pollInterval = null;

document.addEventListener('DOMContentLoaded', async () => {
    await loadFolioStats();
    await loadExecutions();
    await loadBatchPosterExecutions();
    await loadValidations();
});

async function loadFolioStats() {
    const container = document.getElementById('folio-stats');
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/validation/folio-stats`);
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to load stats');
        }
        const stats = await response.json();

        container.innerHTML = `
            <div class="grid grid-4">
                <div class="stat-box">
                    <span class="stat-value">${stats.instances.toLocaleString()}</span>
                    <span class="stat-label">Instances</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value">${stats.holdings.toLocaleString()}</span>
                    <span class="stat-label">Holdings</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value">${stats.items.toLocaleString()}</span>
                    <span class="stat-label">Items</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value">${stats.users.toLocaleString()}</span>
                    <span class="stat-label">Users</span>
                </div>
            </div>
        `;
    } catch (error) {
        container.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
}

async function loadExecutions() {
    const select = document.getElementById('execution-select');
    const startBtn = document.getElementById('start-btn');

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/executions?status=completed&limit=50`);
        const data = await response.json();

        // Filter out BatchPoster - only show Transformer executions
        const transformerExecutions = data.executions.filter(exec =>
            exec.task_type !== 'BatchPoster'
        );

        if (transformerExecutions.length === 0) {
            select.innerHTML = '<option value="">No transformer executions available</option>';
            return;
        }

        select.innerHTML = '<option value="">Select a transformer execution...</option>' +
            transformerExecutions.map(exec => `
                <option value="${exec.id}">
                    #${exec.id} - ${exec.task_name} (${exec.task_type}) - ${new Date(exec.completed_at).toLocaleString('zh-TW')}
                </option>
            `).join('');

        select.addEventListener('change', () => {
            startBtn.disabled = !select.value;
        });

    } catch (error) {
        select.innerHTML = '<option value="">Error loading executions</option>';
        console.error('Error loading executions:', error);
    }
}

async function loadBatchPosterExecutions() {
    const select = document.getElementById('count-execution-select');
    const countBtn = document.getElementById('count-btn');

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/executions?status=completed&limit=50`);
        const data = await response.json();

        // Filter to BatchPoster executions with pre_execution_count
        const batchPosterExecutions = data.executions.filter(exec =>
            exec.task_type === 'BatchPoster' && exec.pre_execution_count !== null
        );

        if (batchPosterExecutions.length === 0) {
            select.innerHTML = '<option value="">No BatchPoster executions with pre-count available</option>';
            return;
        }

        // Store execution data for display
        window._batchPosterExecs = {};
        batchPosterExecutions.forEach(exec => {
            window._batchPosterExecs[exec.id] = exec;
        });

        select.innerHTML = '<option value="">Select a BatchPoster execution...</option>' +
            batchPosterExecutions.map(exec => {
                const total = exec.success_count || exec.total_records || 0;
                const errors = exec.error_count || 0;
                const actualSuccess = errors > 0 ? Math.max(total - errors, 0) : total;
                return `
                <option value="${exec.id}">
                    #${exec.id} - ${exec.task_name} (success: ${actualSuccess} / total: ${total}) - ${new Date(exec.completed_at).toLocaleString('zh-TW')}
                </option>`;
            }).join('');

        select.addEventListener('change', () => {
            countBtn.disabled = !select.value;
            const infoDiv = document.getElementById('count-exec-info');
            if (select.value) {
                const exec = window._batchPosterExecs[select.value];
                const total = exec.success_count || exec.total_records || 0;
                const errors = exec.error_count || 0;
                const actualSuccess = errors > 0 ? Math.max(total - errors, 0) : total;
                document.getElementById('pre-count-display').textContent = exec.pre_execution_count.toLocaleString();
                document.getElementById('posted-count-display').textContent = `${actualSuccess.toLocaleString()} (errors: ${errors})`;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        });

    } catch (error) {
        select.innerHTML = '<option value="">Error loading executions</option>';
        console.error('Error loading BatchPoster executions:', error);
    }
}

async function startCountValidation() {
    const executionId = document.getElementById('count-execution-select').value;
    if (!executionId) {
        alert('Please select a BatchPoster execution');
        return;
    }

    const countBtn = document.getElementById('count-btn');
    countBtn.disabled = true;
    countBtn.textContent = 'Validating...';

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/validation/count-check`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ execution_id: parseInt(executionId) }),
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Count validation failed');
        }

        const result = await response.json();

        // Show result
        const modal = document.getElementById('count-result-modal');
        const content = document.getElementById('count-result-content');
        const isMatch = result.match;

        content.innerHTML = `
            <div class="alert alert-${isMatch ? 'success' : 'danger'} mb-2">
                <strong>${isMatch ? 'PASS' : 'MISMATCH'}</strong> - ${result.message}
            </div>
            <div class="grid grid-4">
                <div class="stat-box">
                    <span class="stat-value">${result.pre_count.toLocaleString()}</span>
                    <span class="stat-label">Pre-Count</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value">${result.post_count.toLocaleString()}</span>
                    <span class="stat-label">Post-Count</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value">${result.actual_diff.toLocaleString()}</span>
                    <span class="stat-label">Actual Diff</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value ${isMatch ? 'text-success' : 'text-danger'}">${result.expected_count.toLocaleString()}</span>
                    <span class="stat-label">Expected</span>
                </div>
            </div>
            <p class="text-muted mt-1" style="font-size: 0.85rem;">
                Record type: ${result.record_type} | Validation ID: <code>${result.validation_id}</code>
            </p>
        `;
        modal.style.display = 'block';

        // Reload validations list
        await loadValidations();

    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        countBtn.disabled = false;
        countBtn.textContent = 'Run Count Validation';
    }
}

async function loadValidations() {
    const tbody = document.getElementById('validations-table');

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/validation/list`);
        if (!response.ok) {
            throw new Error('Failed to load validations');
        }
        const data = await response.json();

        if (data.validations.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No validations yet</td></tr>';
            return;
        }

        tbody.innerHTML = data.validations.map(v => {
            const isCountCheck = v.validation_type === 'count_check';
            const typeBadge = isCountCheck
                ? '<span class="badge badge-info">Count</span>'
                : '<span class="badge badge-secondary">Record</span>';

            let resultsHtml = '-';
            if (v.status === 'completed') {
                if (isCountCheck) {
                    const passed = v.total_mismatches === 0;
                    resultsHtml = passed
                        ? `<span class="text-success">PASS</span>`
                        : `<span class="text-danger">MISMATCH</span>`;
                } else {
                    resultsHtml = `
                        <span class="text-success">${v.total_found}</span> /
                        <span class="text-danger">${v.total_not_found}</span> /
                        <span class="text-warning">${v.total_mismatches}</span>`;
                }
            } else if (v.status === 'failed' && v.error_message) {
                resultsHtml = `<span class="text-danger" title="${escapeHtml(v.error_message)}">${truncate(v.error_message, 30)}</span>`;
            }

            let actionsHtml = '';
            if (v.status === 'completed') {
                if (isCountCheck) {
                    actionsHtml = `<button class="btn btn-sm btn-primary" onclick="showCountDetail('${v.id}')">View</button>`;
                } else {
                    actionsHtml = `<a href="${ROOT_PATH}/clients/${clientCode}/validation/${v.id}" class="btn btn-sm btn-primary">View</a>`;
                }
            } else if (v.status === 'running') {
                actionsHtml = `<button class="btn btn-sm btn-secondary" onclick="pollStatus('${v.id}')">Check</button>`;
            } else if (v.status === 'failed' && v.error_message) {
                actionsHtml = `<button class="btn btn-sm btn-secondary" onclick="alert('${escapeHtml(v.error_message)}')">View Error</button>`;
            }

            if (v.status !== 'running') {
                actionsHtml += ` <button class="btn btn-sm btn-danger" onclick="deleteValidation('${v.id}')">Delete</button>`;
            }

            return `
                <tr>
                    <td><code title="${v.id}">${truncate(v.id, 25)}</code></td>
                    <td>${typeBadge}</td>
                    <td>#${v.execution_id}</td>
                    <td>${v.record_type || '-'}</td>
                    <td><span class="badge badge-${getStatusClass(v.status)}">${v.status}</span></td>
                    <td>${resultsHtml}</td>
                    <td>${new Date(v.created_at).toLocaleString('zh-TW')}</td>
                    <td class="flex gap-1">${actionsHtml}</td>
                </tr>`;
        }).join('');

    } catch (error) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Error: ${error.message}</td></tr>`;
    }
}

async function startValidation() {
    const executionId = document.getElementById('execution-select').value;
    const sampleSize = document.getElementById('sample-size').value;

    if (!executionId) {
        alert('Please select an execution');
        return;
    }

    const startBtn = document.getElementById('start-btn');
    startBtn.disabled = true;
    startBtn.textContent = 'Starting...';

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/validation/start`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                execution_id: parseInt(executionId),
                sample_size: sampleSize ? parseInt(sampleSize) : null,
            }),
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to start validation');
        }

        const result = await response.json();
        currentValidationId = result.validation_id;

        // Show progress
        document.getElementById('validation-progress').style.display = 'block';
        document.getElementById('progress-stats').style.display = 'grid';

        // Reload list
        await loadValidations();

        // Start polling
        pollInterval = setInterval(() => pollStatus(result.validation_id), 2000);

    } catch (error) {
        alert('Error: ' + error.message);
        startBtn.disabled = false;
        startBtn.textContent = 'Start Validation';
    }
}

async function pollStatus(validationId) {
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/validation/status/${validationId}`);
        const status = await response.json();

        // Update progress
        document.getElementById('progress-fill').style.width = `${status.progress_percent}%`;
        document.getElementById('progress-status').textContent =
            `${status.status}: ${status.total_found_in_folio + status.total_not_found + status.total_mismatches + status.total_errors} / ${status.total_local_records} records processed`;

        document.getElementById('stat-found').textContent = status.total_found_in_folio;
        document.getElementById('stat-not-found').textContent = status.total_not_found;
        document.getElementById('stat-mismatch').textContent = status.total_mismatches;
        document.getElementById('stat-errors').textContent = status.total_errors;

        if (status.status === 'completed' || status.status === 'failed') {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }

            document.getElementById('start-btn').disabled = false;
            document.getElementById('start-btn').textContent = 'Start Validation';

            await loadValidations();

            if (status.status === 'completed') {
                document.getElementById('progress-status').innerHTML =
                    `Completed! <a href="${ROOT_PATH}/clients/${clientCode}/validation/${validationId}">View Results</a>`;
            }
        }

    } catch (error) {
        console.error('Error polling status:', error);
    }
}

async function deleteValidation(validationId) {
    if (!confirm(`Delete validation ${validationId}?\n\nThis will permanently remove the validation record and all its results.`)) {
        return;
    }

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/validation/${validationId}`, {
            method: 'DELETE',
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to delete validation');
        }

        await loadValidations();

    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function showCountDetail(validationId) {
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/validation/count-detail/${validationId}`);
        if (!response.ok) throw new Error('Failed to load count validation detail');
        const d = await response.json();

        const modal = document.getElementById('count-result-modal');
        const content = document.getElementById('count-result-content');
        const isMatch = d.match;

        content.innerHTML = `
            <div class="alert alert-${isMatch ? 'success' : 'danger'} mb-2">
                <strong>${isMatch ? 'PASS' : 'MISMATCH'}</strong>
            </div>
            <div class="grid grid-4">
                <div class="stat-box">
                    <span class="stat-value">${(d.pre_count || 0).toLocaleString()}</span>
                    <span class="stat-label">Pre-Count</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value">${(d.post_count || 0).toLocaleString()}</span>
                    <span class="stat-label">Post-Count</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value">${(d.actual_diff || 0).toLocaleString()}</span>
                    <span class="stat-label">Actual Diff</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value ${isMatch ? 'text-success' : 'text-danger'}">${(d.expected_count || 0).toLocaleString()}</span>
                    <span class="stat-label">Expected</span>
                </div>
            </div>
            <p class="text-muted mt-1" style="font-size: 0.85rem;">
                Record type: ${d.record_type || '-'} |
                Duration: ${d.duration_seconds ? d.duration_seconds.toFixed(2) + 's' : '-'}
            </p>
        `;
        modal.style.display = 'block';

    } catch (error) {
        alert('Error loading count validation detail: ' + error.message);
    }
}

function getStatusClass(status) {
    switch (status) {
        case 'completed': return 'success';
        case 'running': return 'info';
        case 'pending': return 'warning';
        case 'failed': return 'danger';
        default: return 'info';
    }
}

function truncate(str, maxLen) {
    if (!str) return '';
    return str.length > maxLen ? str.substring(0, maxLen) + '...' : str;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}
</script>

<style>
.stat-box {
    text-align: center;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
}
.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
}
.stat-label {
    font-size: 0.875rem;
    color: var(--text-muted);
}
.grid-4 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}
@media (max-width: 768px) {
    .grid-4 {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}
