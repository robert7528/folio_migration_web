{% extends "base.html" %}

{% block title %}FOLIO Credentials{% endblock %}

{% block content %}
<div class="flex-between mb-2">
    <h1>FOLIO Credentials</h1>
    <a href="/clients/{{ client_code }}" class="btn btn-secondary">Back to Project</a>
</div>

<div class="card">
    <div class="card-header">
        <span class="card-title">Set FOLIO Login Credentials</span>
    </div>

    <div id="current-status" class="alert alert-info mb-2">
        Loading...
    </div>

    <form id="credentials-form">
        <div class="form-group">
            <label for="username">Username *</label>
            <input type="text" id="username" name="username" required
                   placeholder="FOLIO username">
        </div>

        <div class="form-group">
            <label for="password">Password *</label>
            <input type="password" id="password" name="password" required
                   placeholder="FOLIO password">
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Credentials</button>
            <button type="button" class="btn btn-success" onclick="testConnection()">Test Connection</button>
            <button type="button" class="btn btn-danger" onclick="clearCredentials()">Clear Credentials</button>
        </div>
    </form>

    <div id="result" class="mt-2" style="display: none;"></div>
</div>

<div class="card mt-2">
    <div class="card-header">
        <span class="card-title">Connection Information</span>
    </div>
    <table>
        <tr><td><strong>FOLIO URL</strong></td><td id="folio-url">-</td></tr>
        <tr><td><strong>Tenant ID</strong></td><td id="tenant-id">-</td></tr>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
const clientCode = '{{ client_code }}';

document.addEventListener('DOMContentLoaded', async () => {
    await loadStatus();
});

async function loadStatus() {
    try {
        // Load client info
        const clientResponse = await fetch(`/api/clients/${clientCode}`);
        const client = await clientResponse.json();

        document.getElementById('folio-url').textContent = client.folio_url;
        document.getElementById('tenant-id').textContent = client.tenant_id;

        // Load credentials status
        const credResponse = await fetch(`/api/clients/${clientCode}/credentials`);
        const creds = await credResponse.json();

        const statusEl = document.getElementById('current-status');
        if (creds.credentials_set) {
            statusEl.className = 'alert alert-success mb-2';
            statusEl.textContent = 'Credentials are set. You can update them below.';
        } else {
            statusEl.className = 'alert alert-warning mb-2';
            statusEl.textContent = 'Credentials not set. Please enter your FOLIO credentials.';
        }
    } catch (error) {
        console.error('Error loading status:', error);
    }
}

document.getElementById('credentials-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    try {
        const response = await fetch(`/api/clients/${clientCode}/credentials`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const result = await response.json();
        showResult(response.ok, result.message || (response.ok ? 'Credentials saved successfully' : 'Failed to save'));

        if (response.ok) {
            await loadStatus();
        }
    } catch (error) {
        showResult(false, error.message);
    }
});

async function testConnection() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    if (!username || !password) {
        showResult(false, 'Please enter username and password first');
        return;
    }

    showResult(null, 'Testing connection...');

    try {
        const response = await fetch(`/api/clients/${clientCode}/credentials/test`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const result = await response.json();
        let message = result.message;
        if (result.folio_version) {
            message += ` (FOLIO version: ${result.folio_version})`;
        }
        showResult(result.success, message);
    } catch (error) {
        showResult(false, error.message);
    }
}

async function clearCredentials() {
    if (!confirm('Are you sure you want to clear the credentials?')) {
        return;
    }

    try {
        const response = await fetch(`/api/clients/${clientCode}/credentials`, {
            method: 'DELETE'
        });

        const result = await response.json();
        showResult(response.ok, result.message);

        if (response.ok) {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            await loadStatus();
        }
    } catch (error) {
        showResult(false, error.message);
    }
}

function showResult(success, message) {
    const el = document.getElementById('result');
    if (success === null) {
        el.className = 'alert alert-info mt-2';
    } else {
        el.className = `alert alert-${success ? 'success' : 'danger'} mt-2`;
    }
    el.textContent = message;
    el.style.display = 'block';
}
</script>
{% endblock %}
