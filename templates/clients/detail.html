{% extends "base.html" %}

{% block title %}Project: {{ client_code }}{% endblock %}

{% block content %}
<div class="flex-between mb-2">
    <h1 id="page-title">Project: {{ client_code }}</h1>
    <div class="flex gap-1">
        <a href="{{ root_path }}/clients" class="btn btn-secondary">Back to List</a>
    </div>
</div>

<div id="loading" class="card text-center">
    <span class="spinner"></span> Loading...
</div>

<div id="content" style="display: none;">
    <div class="tabs">
        <button class="tab active" onclick="showTab('overview')">Overview</button>
        <button class="tab" onclick="showTab('credentials')">Credentials</button>
        <button class="tab" onclick="showTab('files')">Files</button>
        <button class="tab" onclick="showTab('config')">Configuration</button>
    </div>

    <!-- Overview Tab -->
    <div id="tab-overview" class="tab-content">
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Project Information</span>
                </div>
                <table>
                    <tr><td><strong>Client Code</strong></td><td id="info-code"></td></tr>
                    <tr><td><strong>Client Name</strong></td><td id="info-name"></td></tr>
                    <tr><td><strong>Client Type</strong></td><td id="info-type"></td></tr>
                    <tr><td><strong>Project Manager</strong></td><td id="info-pm"></td></tr>
                    <tr><td><strong>Start Date</strong></td><td id="info-date"></td></tr>
                    <tr><td><strong>Status</strong></td><td id="info-status"></td></tr>
                </table>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">FOLIO Environment</span>
                </div>
                <table>
                    <tr><td><strong>Gateway URL</strong></td><td id="info-url"></td></tr>
                    <tr><td><strong>Tenant ID</strong></td><td id="info-tenant"></td></tr>
                    <tr><td><strong>Credentials</strong></td><td id="info-creds"></td></tr>
                    <tr><td><strong>Tool Version</strong></td><td id="info-tool"></td></tr>
                    <tr><td><strong>Python Version</strong></td><td id="info-python"></td></tr>
                </table>
            </div>
        </div>

        <div class="card mt-2">
            <div class="card-header">
                <span class="card-title">Iterations</span>
            </div>
            <div id="iterations-list">Loading...</div>
        </div>
    </div>

    <!-- Credentials Tab -->
    <div id="tab-credentials" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <span class="card-title">FOLIO Credentials</span>
            </div>

            <form id="credentials-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Credentials</button>
                    <button type="button" class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
                </div>
            </form>

            <div id="credentials-result" class="mt-2" style="display: none;"></div>
        </div>
    </div>

    <!-- Files Tab -->
    <div id="tab-files" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <span class="card-title">Upload Source Data</span>
            </div>

            <div class="form-group">
                <label for="target-folder">Target Folder</label>
                <select id="target-folder">
                    <option value="instances">instances (MARC bibs)</option>
                    <option value="holdings">holdings</option>
                    <option value="items">items</option>
                    <option value="users">users</option>
                    <option value="loans">loans</option>
                    <option value="courses">courses</option>
                </select>
            </div>

            <div class="file-drop-zone" id="drop-zone">
                <input type="file" id="file-input" accept=".mrc,.marc,.json,.csv,.tsv,.txt,.xml">
                <p>Drop files here or click to upload</p>
                <p class="text-muted">Supported: .mrc, .marc, .json, .csv, .tsv, .txt, .xml</p>
            </div>

            <div id="upload-progress" style="display: none;" class="mt-2">
                <div class="progress-bar">
                    <div class="progress-fill" id="upload-fill" style="width: 0%"></div>
                </div>
                <p class="progress-status" id="upload-status"></p>
            </div>
        </div>

        <div class="card mt-2">
            <div class="card-header">
                <span class="card-title">Project Files</span>
            </div>
            <div id="files-list">Loading...</div>
        </div>
    </div>

    <!-- Configuration Tab -->
    <div id="tab-config" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <span class="card-title">Configuration Files</span>
            </div>
            <div id="config-list">Loading...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const clientCode = '{{ client_code }}';
let clientData = null;

document.addEventListener('DOMContentLoaded', async () => {
    await loadClient();
    setupFileUpload();
});

async function loadClient() {
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}`);
        if (!response.ok) {
            throw new Error('Client not found');
        }
        clientData = await response.json();

        // Update page
        document.getElementById('page-title').textContent = `Project: ${clientData.client_name}`;
        document.getElementById('info-code').textContent = clientData.client_code;
        document.getElementById('info-name').textContent = clientData.client_name;
        document.getElementById('info-type').textContent = clientData.client_type;
        document.getElementById('info-pm').textContent = clientData.pm_name;
        document.getElementById('info-date').textContent = clientData.start_date || '-';
        document.getElementById('info-status').innerHTML = `<span class="badge badge-${getStatusClass(clientData.status)}">${clientData.status}</span>`;
        document.getElementById('info-url').textContent = clientData.folio_url;
        document.getElementById('info-tenant').textContent = clientData.tenant_id;
        document.getElementById('info-creds').innerHTML = clientData.credentials_set
            ? '<span class="badge badge-success">Set</span>'
            : '<span class="badge badge-warning">Not Set</span>';
        document.getElementById('info-tool').textContent = clientData.tool_version || '-';
        document.getElementById('info-python').textContent = clientData.python_version || '-';

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        await loadIterations();
        await loadFiles();
        await loadConfigs();

    } catch (error) {
        document.getElementById('loading').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
    }
}

async function loadIterations() {
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/iterations`);
        const data = await response.json();

        const container = document.getElementById('iterations-list');
        if (data.iterations.length === 0) {
            container.innerHTML = '<p class="text-muted">No iterations found</p>';
        } else {
            container.innerHTML = data.iterations.map(iter => `
                <div class="file-item">
                    <span>${iter}</span>
                    <a href="${ROOT_PATH}/clients/${clientCode}/files?folder=iterations/${iter}" class="btn btn-sm btn-secondary">View Files</a>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading iterations:', error);
    }
}

async function loadFiles() {
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/files`);
        const data = await response.json();

        const container = document.getElementById('files-list');
        if (data.files.length === 0) {
            container.innerHTML = '<p class="text-muted">No files</p>';
        } else {
            container.innerHTML = `<table>
                <thead><tr><th>Name</th><th>Size</th><th>Actions</th></tr></thead>
                <tbody>
                    ${data.files.map(file => `
                        <tr>
                            <td>${file.is_dir ? 'üìÅ ' : 'üìÑ '}${file.name}</td>
                            <td>${file.is_dir ? '-' : formatSize(file.size)}</td>
                            <td>
                                ${file.is_dir
                                    ? `<a href="${ROOT_PATH}/clients/${clientCode}/files?folder=${file.path}" class="btn btn-sm btn-secondary">Open</a>`
                                    : `<a href="${ROOT_PATH}/api/clients/${clientCode}/files/${file.path}" class="btn btn-sm btn-secondary">Download</a>`
                                }
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
        }
    } catch (error) {
        console.error('Error loading files:', error);
    }
}

async function loadConfigs() {
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/config`);
        const data = await response.json();

        const container = document.getElementById('config-list');
        if (data.files.length === 0) {
            container.innerHTML = '<p class="text-muted">No configuration files</p>';
        } else {
            container.innerHTML = data.files.map(file => `
                <div class="file-item">
                    <span>${file.filename}</span>
                    <a href="${ROOT_PATH}/clients/${clientCode}/config/${file.filename}" class="btn btn-sm btn-primary">Edit</a>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading configs:', error);
    }
}

function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

    event.target.classList.add('active');
    document.getElementById(`tab-${tabName}`).style.display = 'block';
}

// Credentials
document.getElementById('credentials-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/credentials`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const result = await response.json();
        showCredentialsResult(response.ok, result.message || 'Credentials saved');
        if (response.ok) {
            await loadClient();
        }
    } catch (error) {
        showCredentialsResult(false, error.message);
    }
});

async function testConnection() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/credentials/test`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const result = await response.json();
        showCredentialsResult(result.success, result.message + (result.folio_version ? ` (FOLIO ${result.folio_version})` : ''));
    } catch (error) {
        showCredentialsResult(false, error.message);
    }
}

function showCredentialsResult(success, message) {
    const el = document.getElementById('credentials-result');
    el.className = `alert alert-${success ? 'success' : 'danger'}`;
    el.textContent = message;
    el.style.display = 'block';
}

// File upload
function setupFileUpload() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            uploadFile(e.dataTransfer.files[0]);
        }
    });
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
            uploadFile(fileInput.files[0]);
        }
    });
}

async function uploadFile(file) {
    const targetFolder = document.getElementById('target-folder').value;
    const progressEl = document.getElementById('upload-progress');
    const fillEl = document.getElementById('upload-fill');
    const statusEl = document.getElementById('upload-status');

    progressEl.style.display = 'block';
    fillEl.style.width = '0%';
    statusEl.textContent = `Uploading ${file.name}...`;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('target_folder', targetFolder);

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/files/upload`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Upload failed');
        }

        const result = await response.json();
        fillEl.style.width = '100%';
        statusEl.textContent = `Uploaded ${result.filename} (${formatSize(result.size)})`;

        await loadFiles();
    } catch (error) {
        statusEl.textContent = `Error: ${error.message}`;
    }
}

function getStatusClass(status) {
    switch (status) {
        case 'ready': return 'success';
        case 'initializing': return 'warning';
        case 'error': return 'danger';
        default: return 'info';
    }
}

function formatSize(bytes) {
    const units = ['B', 'KB', 'MB', 'GB'];
    let i = 0;
    while (bytes >= 1024 && i < units.length - 1) {
        bytes /= 1024;
        i++;
    }
    return `${bytes.toFixed(1)} ${units[i]}`;
}
</script>
{% endblock %}
