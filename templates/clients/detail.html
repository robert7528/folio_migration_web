{% extends "base.html" %}

{% block title %}Project: {{ client_code }}{% endblock %}

{% block content %}
<div class="flex-between mb-2">
    <h1 id="page-title">Project: {{ client_code }}</h1>
    <div class="flex gap-1">
        <a href="{{ root_path }}/clients/{{ client_code }}/execute" class="btn btn-success">Execute Tasks</a>
        <button class="btn btn-primary" onclick="showEditModal()">Edit Project</button>
        <button class="btn btn-danger" onclick="deleteProject()">Delete Project</button>
        <a href="{{ root_path }}/clients" class="btn btn-secondary">Back to List</a>
    </div>
</div>

<!-- Edit Modal -->
<div id="edit-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Project</h2>
            <button class="modal-close" onclick="hideEditModal()">&times;</button>
        </div>
        <form id="edit-form">
            <div class="form-group">
                <label for="edit-client_name">Client Name</label>
                <input type="text" id="edit-client_name" name="client_name" required>
            </div>
            <div class="form-group">
                <label for="edit-client_type">Client Type</label>
                <select id="edit-client_type" name="client_type">
                    <option value="university">University</option>
                    <option value="public">Public Library</option>
                    <option value="special">Special Library</option>
                    <option value="corporate">Corporate</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-folio_url">FOLIO Gateway URL</label>
                <input type="url" id="edit-folio_url" name="folio_url" required>
            </div>
            <div class="form-group">
                <label for="edit-tenant_id">Tenant ID</label>
                <input type="text" id="edit-tenant_id" name="tenant_id" required>
            </div>
            <div class="form-group">
                <label for="edit-pm_name">Project Manager</label>
                <input type="text" id="edit-pm_name" name="pm_name" required>
            </div>
            <div class="form-group">
                <label for="edit-start_date">Start Date</label>
                <input type="date" id="edit-start_date" name="start_date">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="hideEditModal()">Cancel</button>
            </div>
            <div id="edit-result" class="mt-2" style="display: none;"></div>
        </form>
    </div>
</div>

<div id="loading" class="card text-center">
    <span class="spinner"></span> Loading...
</div>

<div id="content" style="display: none;">
    <div class="tabs">
        <button class="tab active" onclick="showTab('overview')">Overview</button>
        <button class="tab" onclick="showTab('credentials')">Credentials</button>
        <button class="tab" onclick="showTab('tasks')">Tasks</button>
        <button class="tab" onclick="showTab('files')">Files</button>
        <button class="tab" onclick="showTab('config')">Configuration</button>
    </div>

    <!-- Overview Tab -->
    <div id="tab-overview" class="tab-content">
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Project Information</span>
                </div>
                <table>
                    <tr><td><strong>Client Code</strong></td><td id="info-code"></td></tr>
                    <tr><td><strong>Client Name</strong></td><td id="info-name"></td></tr>
                    <tr><td><strong>Client Type</strong></td><td id="info-type"></td></tr>
                    <tr><td><strong>Project Manager</strong></td><td id="info-pm"></td></tr>
                    <tr><td><strong>Start Date</strong></td><td id="info-date"></td></tr>
                    <tr><td><strong>Status</strong></td><td id="info-status"></td></tr>
                </table>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">FOLIO Environment</span>
                </div>
                <table>
                    <tr><td><strong>Gateway URL</strong></td><td id="info-url"></td></tr>
                    <tr><td><strong>Tenant ID</strong></td><td id="info-tenant"></td></tr>
                    <tr><td><strong>Credentials</strong></td><td id="info-creds"></td></tr>
                    <tr><td><strong>Tool Version</strong></td><td id="info-tool"></td></tr>
                    <tr><td><strong>Python Version</strong></td><td id="info-python"></td></tr>
                </table>
            </div>
        </div>

        <div class="card mt-2">
            <div class="card-header">
                <span class="card-title">Iterations</span>
            </div>
            <div id="iterations-list">Loading...</div>
        </div>
    </div>

    <!-- Credentials Tab -->
    <div id="tab-credentials" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <span class="card-title">FOLIO Credentials</span>
            </div>

            <form id="credentials-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Credentials</button>
                    <button type="button" class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
                </div>
            </form>

            <div id="credentials-result" class="mt-2" style="display: none;"></div>
        </div>
    </div>

    <!-- Tasks Tab -->
    <div id="tab-tasks" class="tab-content" style="display: none;">
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Migration Tasks</span>
                    <button class="btn btn-sm btn-primary" onclick="generateCombinedConfig()">Generate Combined Config</button>
                </div>
                <div id="tasks-list">Loading...</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Mapping Files</span>
                </div>
                <div id="mappings-list">Loading...</div>
            </div>
        </div>

        <!-- Task Config Editor -->
        <div id="task-config-panel" class="card mt-2" style="display: none;">
            <div class="card-header">
                <span class="card-title">Task Configuration: <span id="task-config-name"></span></span>
                <button class="btn btn-sm btn-secondary" onclick="hideTaskConfig()">Close</button>
            </div>
            <div class="form-group">
                <textarea id="task-config-editor" rows="20" style="font-family: monospace; width: 100%;"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveTaskConfig()">Save Configuration</button>
                <button class="btn btn-secondary" onclick="validateTaskConfig()">Validate JSON</button>
            </div>
            <div id="task-config-result" class="mt-2" style="display: none;"></div>
        </div>
    </div>

    <!-- Files Tab -->
    <div id="tab-files" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <span class="card-title">Upload Source Data</span>
            </div>

            <div class="form-group">
                <label for="target-folder">Target Folder</label>
                <select id="target-folder">
                    <option value="instances">instances (MARC bibs)</option>
                    <option value="holdings">holdings</option>
                    <option value="items">items</option>
                    <option value="users">users</option>
                    <option value="loans">loans</option>
                    <option value="courses">courses</option>
                </select>
            </div>

            <div class="file-drop-zone" id="drop-zone">
                <input type="file" id="file-input" accept=".mrc,.marc,.iso,.json,.csv,.tsv,.txt,.xml">
                <p>Drop files here or click to upload</p>
                <p class="text-muted">Supported: .mrc, .marc, .iso, .json, .csv, .tsv, .txt, .xml</p>
            </div>

            <div id="upload-progress" style="display: none;" class="mt-2">
                <div class="progress-bar">
                    <div class="progress-fill" id="upload-fill" style="width: 0%"></div>
                </div>
                <p class="progress-status" id="upload-status"></p>
            </div>
        </div>

        <div class="card mt-2">
            <div class="card-header">
                <span class="card-title">Project Files</span>
            </div>
            <div id="files-list">Loading...</div>
        </div>
    </div>

    <!-- Configuration Tab -->
    <div id="tab-config" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <span class="card-title">Configuration Files</span>
            </div>
            <div id="config-list">Loading...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const clientCode = '{{ client_code }}';
let clientData = null;

document.addEventListener('DOMContentLoaded', async () => {
    await loadClient();
    setupFileUpload();
});

async function loadClient() {
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}`);
        if (!response.ok) {
            throw new Error('Client not found');
        }
        clientData = await response.json();

        // Update page
        document.getElementById('page-title').textContent = `Project: ${clientData.client_name}`;
        document.getElementById('info-code').textContent = clientData.client_code;
        document.getElementById('info-name').textContent = clientData.client_name;
        document.getElementById('info-type').textContent = clientData.client_type;
        document.getElementById('info-pm').textContent = clientData.pm_name;
        document.getElementById('info-date').textContent = clientData.start_date || '-';
        document.getElementById('info-status').innerHTML = `<span class="badge badge-${getStatusClass(clientData.status)}">${clientData.status}</span>`;
        document.getElementById('info-url').textContent = clientData.folio_url;
        document.getElementById('info-tenant').textContent = clientData.tenant_id;
        document.getElementById('info-creds').innerHTML = clientData.credentials_set
            ? '<span class="badge badge-success">Set</span>'
            : '<span class="badge badge-warning">Not Set</span>';
        document.getElementById('info-tool').textContent = clientData.tool_version || '-';
        document.getElementById('info-python').textContent = clientData.python_version || '-';

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        await loadIterations();
        await loadFiles();
        await loadConfigs();
        await loadTasks();
        await loadMappings();

    } catch (error) {
        document.getElementById('loading').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
    }
}

async function loadIterations() {
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/iterations`);
        const data = await response.json();

        const container = document.getElementById('iterations-list');
        if (data.iterations.length === 0) {
            container.innerHTML = '<p class="text-muted">No iterations found</p>';
        } else {
            container.innerHTML = data.iterations.map(iter => `
                <div class="file-item">
                    <span>${iter}</span>
                    <a href="${ROOT_PATH}/clients/${clientCode}/files?folder=iterations/${iter}" class="btn btn-sm btn-secondary">View Files</a>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading iterations:', error);
    }
}

async function loadFiles() {
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/files`);
        const data = await response.json();

        const container = document.getElementById('files-list');
        if (data.files.length === 0) {
            container.innerHTML = '<p class="text-muted">No files</p>';
        } else {
            container.innerHTML = `<table>
                <thead><tr><th>Name</th><th>Size</th><th>Actions</th></tr></thead>
                <tbody>
                    ${data.files.map(file => `
                        <tr>
                            <td>${file.is_dir ? 'üìÅ ' : 'üìÑ '}${file.name}</td>
                            <td>${file.is_dir ? '-' : formatSize(file.size)}</td>
                            <td>
                                ${file.is_dir
                                    ? `<a href="${ROOT_PATH}/clients/${clientCode}/files?folder=${file.path}" class="btn btn-sm btn-secondary">Open</a>`
                                    : `<a href="${ROOT_PATH}/api/clients/${clientCode}/files/${file.path}" class="btn btn-sm btn-secondary">Download</a>`
                                }
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
        }
    } catch (error) {
        console.error('Error loading files:', error);
    }
}

async function loadConfigs() {
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/config`);
        const data = await response.json();

        const container = document.getElementById('config-list');
        if (data.files.length === 0) {
            container.innerHTML = '<p class="text-muted">No configuration files</p>';
        } else {
            container.innerHTML = data.files.map(file => `
                <div class="file-item">
                    <span>${file.filename}</span>
                    <a href="${ROOT_PATH}/clients/${clientCode}/config/${file.filename}" class="btn btn-sm btn-primary">Edit</a>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Error loading configs:', error);
    }
}

function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

    event.target.classList.add('active');
    document.getElementById(`tab-${tabName}`).style.display = 'block';
}

// Credentials
document.getElementById('credentials-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/credentials`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const result = await response.json();
        showCredentialsResult(response.ok, result.message || 'Credentials saved');
        if (response.ok) {
            await loadClient();
        }
    } catch (error) {
        showCredentialsResult(false, error.message);
    }
});

async function testConnection() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/credentials/test`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const result = await response.json();
        showCredentialsResult(result.success, result.message + (result.folio_version ? ` (FOLIO ${result.folio_version})` : ''));
    } catch (error) {
        showCredentialsResult(false, error.message);
    }
}

function showCredentialsResult(success, message) {
    const el = document.getElementById('credentials-result');
    el.className = `alert alert-${success ? 'success' : 'danger'}`;
    el.textContent = message;
    el.style.display = 'block';
}

// File upload
function setupFileUpload() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            uploadFile(e.dataTransfer.files[0]);
        }
    });
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
            uploadFile(fileInput.files[0]);
        }
    });
}

async function uploadFile(file) {
    const targetFolder = document.getElementById('target-folder').value;
    const progressEl = document.getElementById('upload-progress');
    const fillEl = document.getElementById('upload-fill');
    const statusEl = document.getElementById('upload-status');

    progressEl.style.display = 'block';
    fillEl.style.width = '0%';
    statusEl.textContent = `Uploading ${file.name}...`;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('target_folder', targetFolder);

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/files/upload`, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Upload failed');
        }

        const result = await response.json();
        fillEl.style.width = '100%';
        statusEl.textContent = `Uploaded ${result.filename} (${formatSize(result.size)})`;

        await loadFiles();
    } catch (error) {
        statusEl.textContent = `Error: ${error.message}`;
    }
}

// Tasks Management
let tasksData = {};
let currentTaskType = null;

async function loadTasks() {
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/tasks`);
        const data = await response.json();
        tasksData = data.tasks;

        const container = document.getElementById('tasks-list');
        const taskTypes = Object.keys(data.tasks);

        if (taskTypes.length === 0) {
            container.innerHTML = '<p class="text-muted">No tasks configured</p>';
            return;
        }

        container.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${taskTypes.map(taskType => {
                        const task = data.tasks[taskType];
                        return `
                            <tr>
                                <td>
                                    <strong>${task.name}</strong><br>
                                    <small class="text-muted">${task.transformer || '-'}</small>
                                </td>
                                <td>
                                    <label class="toggle-switch">
                                        <input type="checkbox"
                                            ${task.enabled ? 'checked' : ''}
                                            onchange="toggleTask('${taskType}', this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-secondary" onclick="showTaskConfig('${taskType}')">
                                        Configure
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        console.error('Error loading tasks:', error);
        document.getElementById('tasks-list').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
    }
}

async function toggleTask(taskType, enabled) {
    try {
        const action = enabled ? 'enable' : 'disable';
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/tasks/${taskType}/${action}`, {
            method: 'POST'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || `Failed to ${action} task`);
        }

        // Reload tasks to reflect changes
        await loadTasks();
    } catch (error) {
        alert('Error: ' + error.message);
        await loadTasks(); // Reload to reset checkbox state
    }
}

async function showTaskConfig(taskType) {
    currentTaskType = taskType;
    const task = tasksData[taskType];

    document.getElementById('task-config-name').textContent = task.name;
    document.getElementById('task-config-result').style.display = 'none';

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/tasks/${taskType}`);
        const data = await response.json();

        document.getElementById('task-config-editor').value = JSON.stringify(data.config, null, 2);
        document.getElementById('task-config-panel').style.display = 'block';

        // Scroll to the config panel
        document.getElementById('task-config-panel').scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        alert('Error loading task config: ' + error.message);
    }
}

function hideTaskConfig() {
    document.getElementById('task-config-panel').style.display = 'none';
    currentTaskType = null;
}

function validateTaskConfig() {
    const textarea = document.getElementById('task-config-editor');
    const resultEl = document.getElementById('task-config-result');

    try {
        JSON.parse(textarea.value);
        resultEl.className = 'alert alert-success mt-2';
        resultEl.textContent = 'Valid JSON';
        resultEl.style.display = 'block';
    } catch (error) {
        resultEl.className = 'alert alert-danger mt-2';
        resultEl.textContent = 'Invalid JSON: ' + error.message;
        resultEl.style.display = 'block';
    }
}

async function saveTaskConfig() {
    if (!currentTaskType) return;

    const textarea = document.getElementById('task-config-editor');
    const resultEl = document.getElementById('task-config-result');

    let config;
    try {
        config = JSON.parse(textarea.value);
    } catch (error) {
        resultEl.className = 'alert alert-danger mt-2';
        resultEl.textContent = 'Invalid JSON: ' + error.message;
        resultEl.style.display = 'block';
        return;
    }

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/tasks/${currentTaskType}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ config })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to save configuration');
        }

        resultEl.className = 'alert alert-success mt-2';
        resultEl.textContent = 'Configuration saved successfully';
        resultEl.style.display = 'block';

        await loadTasks();
    } catch (error) {
        resultEl.className = 'alert alert-danger mt-2';
        resultEl.textContent = error.message;
        resultEl.style.display = 'block';
    }
}

async function loadMappings() {
    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/tasks/mappings/list`);
        const data = await response.json();

        const container = document.getElementById('mappings-list');
        if (data.mappings.length === 0) {
            container.innerHTML = '<p class="text-muted">No mapping files</p>';
            return;
        }

        container.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Size</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.mappings.map(mapping => `
                        <tr>
                            <td>${mapping.filename}</td>
                            <td>${formatSize(mapping.size)}</td>
                            <td>
                                <a href="${ROOT_PATH}/clients/${clientCode}/config/${mapping.filename}" class="btn btn-sm btn-secondary">Edit</a>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        console.error('Error loading mappings:', error);
        document.getElementById('mappings-list').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
    }
}

async function generateCombinedConfig() {
    if (!confirm('Generate combined migration_config.json from enabled tasks?\n\nThis will overwrite the existing file if present.')) {
        return;
    }

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}/tasks/generate-combined`, {
            method: 'POST'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to generate config');
        }

        const result = await response.json();
        alert(`Generated ${result.filename}\nEnabled tasks: ${result.enabled_tasks.join(', ') || 'none'}`);

        await loadConfigs();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function getStatusClass(status) {
    switch (status) {
        case 'ready': return 'success';
        case 'initializing': return 'warning';
        case 'error': return 'danger';
        default: return 'info';
    }
}

function formatSize(bytes) {
    const units = ['B', 'KB', 'MB', 'GB'];
    let i = 0;
    while (bytes >= 1024 && i < units.length - 1) {
        bytes /= 1024;
        i++;
    }
    return `${bytes.toFixed(1)} ${units[i]}`;
}

// Edit Modal
function showEditModal() {
    if (!clientData) return;

    document.getElementById('edit-client_name').value = clientData.client_name;
    document.getElementById('edit-client_type').value = clientData.client_type;
    document.getElementById('edit-folio_url').value = clientData.folio_url;
    document.getElementById('edit-tenant_id').value = clientData.tenant_id;
    document.getElementById('edit-pm_name').value = clientData.pm_name;
    document.getElementById('edit-start_date').value = clientData.start_date || '';
    document.getElementById('edit-result').style.display = 'none';

    document.getElementById('edit-modal').style.display = 'flex';
}

function hideEditModal() {
    document.getElementById('edit-modal').style.display = 'none';
}

document.getElementById('edit-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const data = {
        client_name: document.getElementById('edit-client_name').value,
        client_type: document.getElementById('edit-client_type').value,
        folio_url: document.getElementById('edit-folio_url').value,
        tenant_id: document.getElementById('edit-tenant_id').value,
        pm_name: document.getElementById('edit-pm_name').value,
        start_date: document.getElementById('edit-start_date').value || null
    };

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Update failed');
        }

        const result = document.getElementById('edit-result');
        result.className = 'alert alert-success mt-2';
        result.textContent = 'Project updated successfully';
        result.style.display = 'block';

        // Reload data and close modal after a short delay
        setTimeout(async () => {
            hideEditModal();
            await loadClient();
        }, 1000);

    } catch (error) {
        const result = document.getElementById('edit-result');
        result.className = 'alert alert-danger mt-2';
        result.textContent = error.message;
        result.style.display = 'block';
    }
});

// Close modal when clicking outside
document.getElementById('edit-modal').addEventListener('click', (e) => {
    if (e.target.id === 'edit-modal') {
        hideEditModal();
    }
});

// Delete Project
async function deleteProject() {
    const projectName = clientData ? clientData.client_name : clientCode;

    if (!confirm(`Are you sure you want to delete project "${projectName}"?\n\nThis will permanently remove:\n- All project files\n- Configuration files\n- Uploaded data\n\nThis action cannot be undone.`)) {
        return;
    }

    // Double confirm for safety
    if (!confirm(`Final confirmation: Delete "${clientCode}" and all its data?`)) {
        return;
    }

    try {
        const response = await fetch(`${ROOT_PATH}/api/clients/${clientCode}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Delete failed');
        }

        alert('Project deleted successfully');
        window.location.href = `${ROOT_PATH}/clients`;

    } catch (error) {
        alert('Error deleting project: ' + error.message);
    }
}
</script>
{% endblock %}
